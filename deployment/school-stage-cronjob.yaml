apiVersion: batch/v1
kind: CronJob
metadata:
  name: school-stage-cronjob
  namespace: stage-managex-school
spec:
  schedule: "*/1 * * * *" # Runs every minute
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: school-stage-cronjob
        spec:
          serviceAccountName: school-stage-service
          volumes:
            - name: school-secrets-environment-file
              csi:
                driver: secrets-store.csi.k8s.io
                readOnly: true
                volumeAttributes:
                  secretProviderClass: "school-stage-secrets"
          containers:
            - name: school-stage-cronjob
              image: 399600302704.dkr.ecr.ap-south-1.amazonaws.com/stage-managex-school:school-stage-542f33b0e4851c9f7428e6b97eb98570317c1e43
              command: ["php", "/var/www/html/artisan", "schedule:run"]
              volumeMounts:
                - name: school-secrets-environment-file
                  mountPath: "/mnt/secret-store/"
                  readOnly: true
              lifecycle:
                postStart:
                  exec:
                    command: ['sh', '-c', 'cp /mnt/secret-store/.env /var/www/html/.env']
          restartPolicy: OnFailure
